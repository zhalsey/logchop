<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Log Chop</title>
<meta name="description" content="Chop logs, sell firewood, upgrade your gear. A lumberjack tycoon idle game. Grab your axe and start splitting!">
<meta name="theme-color" content="#1a1a2e">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta property="og:title" content="Log Chop - Lumberjack Tycoon Game">
<meta property="og:description" content="Chop logs, sell firewood, upgrade your gear. A lumberjack tycoon idle game.">
<meta property="og:image" content="og-image.png">
<meta property="og:type" content="website">
<link rel="icon" type="image/x-icon" href="favicon.ico">
<link rel="icon" type="image/png" sizes="32x32" href="icon-32x32.png">
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="192x192" href="icon-192x192.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;background:#1a1a2e;font-family:'Press Start 2P',monospace;user-select:none;-webkit-user-select:none;touch-action:none}
#game-container{width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative}
#hud{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;color:#e8d5b0;font-size:10px;position:absolute;top:2px;left:0;right:0;text-align:center;z-index:10;padding:2px 8px}
#hud span{text-shadow:1px 1px 0 #333;white-space:nowrap}
.hc{color:#ffd700!important}.ha{color:#a0c8ff!important}.hl{color:#80e080!important}.hp{color:#ff9966!important}
canvas{image-rendering:pixelated;display:block}
#instructions{color:#888;text-align:center;line-height:2;font-size:9px;position:absolute;bottom:2px;left:0;right:0;z-index:10;padding:0 8px}
#instructions strong{color:#c8a96e}
#touch-controls{display:none;position:absolute;bottom:6px;right:6px;z-index:20;gap:4px;flex-wrap:wrap;justify-content:flex-end;max-width:320px}
.tb{background:rgba(200,169,110,0.3);border:2px solid rgba(200,169,110,0.5);color:#c8a96e;font-family:'Press Start 2P',monospace;border-radius:6px;padding:7px 10px;font-size:9px;cursor:pointer;white-space:nowrap;-webkit-tap-highlight-color:transparent}
.tb:active{background:rgba(200,169,110,0.6)}
.tc{background:rgba(255,100,50,0.35);border-color:rgba(255,100,50,0.6);color:#ff9966;font-size:12px;padding:10px 18px}
@media(pointer:coarse){#touch-controls{display:flex}#instructions{display:none}}
@media(max-width:600px){#hud{font-size:7px;gap:6px}}
</style>
</head>
<body>
<div id="game-container">
<div id="hud">
  <span>LOGS:<span id="hScore">0</span></span>
  <span class="hc">COINS:<span id="hCoins">0</span></span>
  <span class="ha">AXE:<span id="hAxe">Starter</span></span>
  <span class="hl">HUSTLE:<span id="hCoffee">Normal</span></span>
  <span class="hp">POWER:<span id="hJerky">Normal</span></span>
</div>
<canvas id="game"></canvas>
<div id="instructions">
  <strong>CLICK</strong> walk | <strong>SPACE</strong> chop | <strong>M</strong> sell dry stack | <strong>U</strong> axe | <strong>C</strong> coffee | <strong>J</strong> jerky | <strong>S</strong> stack wood (50+)
</div>
<div id="touch-controls">
  <button class="tb" onclick="doSell()">SELL</button>
  <button class="tb" onclick="doStack()">STACK</button>
  <button class="tb" onclick="upgradeAxe()">AXE</button>
  <button class="tb" onclick="buyCoffee()">COFFEE</button>
  <button class="tb" onclick="buyJerky()">JERKY</button>
  <button class="tb tc" onclick="doChop()">CHOP</button>
</div>
</div>

<script>
const C=document.getElementById('game'),X=C.getContext('2d');
const GW=960,GH=560;C.width=GW;C.height=GH;

function resize(){const s=Math.min(innerWidth/GW,innerHeight/GH);C.style.width=Math.floor(GW*s)+'px';C.style.height=Math.floor(GH*s)+'px';}
addEventListener('resize',resize);addEventListener('orientationchange',()=>setTimeout(resize,200));resize();
function s2g(sx,sy){const r=C.getBoundingClientRect();return{x:(sx-r.left)/(r.width/GW),y:(sy-r.top)/(r.height/GH)};}

// ─── SPECIES ───
const SPECIES=[
  {id:'alder',name:'Red Alder',abbr:'ALDER',logColor:'#c4a87a',ringColor:'#b8a88a',
   baseChops:3,btu:19.5,coinsPer:2,dryTime:30,seasonMo:'4-9',color:'#d4b890'},
  {id:'fir',name:'Douglas Fir',abbr:'D.FIR',logColor:'#a0522d',ringColor:'#7a3e22',
   baseChops:4,btu:20.5,coinsPer:2.5,dryTime:40,seasonMo:'6-9',color:'#8B6914'},
  {id:'maple',name:'Bigleaf Maple',abbr:'MAPLE',logColor:'#c89050',ringColor:'#a07030',
   baseChops:5,btu:22.7,coinsPer:3,dryTime:50,seasonMo:'6-8',color:'#b87830'},
  {id:'oak',name:'Oregon White Oak',abbr:'OAK',logColor:'#8B7355',ringColor:'#6b5535',
   baseChops:7,btu:28.0,coinsPer:4,dryTime:70,seasonMo:'9-12+',color:'#7a6040'},
  {id:'madrone',name:'Pacific Madrone',abbr:'MADRONE',logColor:'#c06040',ringColor:'#a04830',
   baseChops:9,btu:30.9,coinsPer:5,dryTime:80,seasonMo:'9-12',color:'#d05a3a'},
];

// ─── UPGRADES ───
const AXES=[
  {name:'Starter',color:'#a0a0a8',shine:'#d0d0d8',multi:1,cost:0},
  {name:'Steel',color:'#b0b8c0',shine:'#e0e8f0',multi:0.8,cost:30},
  {name:'Hardened',color:'#7ec8e3',shine:'#b0e8ff',multi:0.65,cost:90},
  {name:'Mythril',color:'#90e090',shine:'#c0ffc0',multi:0.5,cost:250},
  {name:'Golden',color:'#ffd700',shine:'#fff4a0',multi:0.35,cost:600},
];
const COFFEES=[{name:'Normal',speed:1.8,cost:0},{name:'Coffee',speed:2.6,cost:12},{name:'Dbl Shot',speed:3.4,cost:35},{name:'Triple',speed:4.2,cost:80},{name:'Espresso IV',speed:5.2,cost:200}];
const JERKYS=[{name:'Normal',cs:0.020,cost:0},{name:'Jerky',cs:0.026,cost:15},{name:'Dbl Jerky',cs:0.033,cost:45},{name:'Smoked',cs:0.042,cost:100},{name:'Brisket',cs:0.055,cost:250}];
let axeLv=0,coffeeLv=0,jerkyLv=0;

// ─── STATE ───
let logsChopped=0,coins=0,gt=0,marketMsg=null,cutscene=null;

// Fresh wood piles per species: {alder:count, fir:count, ...}
let freshWood={};
SPECIES.forEach(s=>freshWood[s.id]=0);

// Drying stacks: [{speciesId, pieces, dryProgress(0-1), dryTime, x, y, slot}]
let dryingStacks=[];
const MAX_STACKS_PER=5, STACK_SIZE=50;

// ─── JACK ───
const J={x:400,y:380,tx:400,f:1,wt:0,walk:false,chop:false,cp:0,
  carry:false,cc:0,hasAxe:true,jit:0,jitT:0,drink:false,eat:false,flex:false,flexT:0,
  carrySpecies:null};
function spd(){return COFFEES[coffeeLv].speed;}
function cspd(){return JERKYS[jerkyLv].cs;}

// ─── LOGS ───
let logs=[],splitAnims=[],particles=[],floatMsgs=[],bsSparks=[];
const BLOCK_X=[140,280,420,560,700];

function maxChops(sp){return Math.max(1,Math.round(sp.baseChops*AXES[axeLv].multi));}

function spawnLog(){
  const avail=BLOCK_X.filter(px=>!logs.some(l=>!l.done&&Math.abs(l.x-px)<60));
  if(!avail.length)return;
  const x=avail[Math.floor(Math.random()*avail.length)];
  const sp=SPECIES[Math.floor(Math.random()*SPECIES.length)];
  logs.push({x,y:410,sp,done:false,prog:0,max:maxChops(sp),diam:28+Math.random()*18});
}
for(let i=0;i<4;i++)spawnLog();

function isBusy(){return cutscene||J.chop;}
function startCS(t,d){cutscene={type:t,phase:0,timer:0,data:d||{}};}

// ─── DRYING STACK LAYOUT ───
// Stacks line up along the back, organized by species
const STACK_BASE_Y=305, STACK_SPACING_X=36;
function getStackPos(speciesIdx, slot){
  const baseX=60+speciesIdx*180;
  return{x:baseX+slot*STACK_SPACING_X, y:STACK_BASE_Y};
}

function addDryingStack(speciesId){
  const si=SPECIES.findIndex(s=>s.id===speciesId);
  const sp=SPECIES[si];
  const existing=dryingStacks.filter(s=>s.speciesId===speciesId);
  if(existing.length>=MAX_STACKS_PER)return false;
  const slot=existing.length;
  const pos=getStackPos(si,slot);
  dryingStacks.push({speciesId,pieces:STACK_SIZE,dryProgress:0,dryTime:sp.dryTime,x:pos.x,y:pos.y,slot,done:false});
  freshWood[speciesId]-=STACK_SIZE;
  return true;
}

function getReadyStack(){
  return dryingStacks.find(s=>s.done);
}

// ─── DRAWING HELPERS ───
function gf(s){return s+'px "Press Start 2P"';}

function drawSky(){const g=X.createLinearGradient(0,0,0,310);g.addColorStop(0,'#5b8fb9');g.addColorStop(1,'#87ceeb');X.fillStyle=g;X.fillRect(0,0,GW,310);X.fillStyle='#fff4a0';X.beginPath();X.arc(870,55,25,0,Math.PI*2);X.fill();X.fillStyle='#ffd700';X.beginPath();X.arc(870,55,20,0,Math.PI*2);X.fill();}

function drawClouds(t){X.fillStyle='rgba(255,255,255,0.7)';[[100,55,55],[350,35,42],[600,60,50],[800,45,38]].forEach(([bx,by,sz])=>{const cx=(bx+t*0.008)%1000-30;X.beginPath();X.arc(cx,by,sz*0.6,0,Math.PI*2);X.arc(cx+sz*0.4,by-sz*0.2,sz*0.5,0,Math.PI*2);X.arc(cx+sz*0.8,by,sz*0.4,0,Math.PI*2);X.fill();});}

function drawMountains(){X.fillStyle='#3a6b35';X.beginPath();X.moveTo(-20,290);X.lineTo(120,140);X.lineTo(260,270);X.lineTo(400,130);X.lineTo(540,275);X.lineTo(680,150);X.lineTo(820,260);X.lineTo(920,165);X.lineTo(980,280);X.lineTo(980,290);X.fill();X.fillStyle='#2d5a27';X.beginPath();X.moveTo(-20,300);X.lineTo(80,210);X.lineTo(220,290);X.lineTo(440,200);X.lineTo(600,290);X.lineTo(760,210);X.lineTo(900,285);X.lineTo(980,240);X.lineTo(980,300);X.fill();}

function drawGround(){const g=X.createLinearGradient(0,300,0,GH);g.addColorStop(0,'#5a8f3c');g.addColorStop(0.12,'#4a7a3b');g.addColorStop(1,'#3d6630');X.fillStyle=g;X.fillRect(0,300,GW,260);
// Dirt clearing
X.fillStyle='#6b5030';X.beginPath();X.ellipse(420,430,320,40,0,0,Math.PI*2);X.fill();X.fillStyle='#7a5c38';X.beginPath();X.ellipse(420,428,310,35,0,0,Math.PI*2);X.fill();}

function drawBgTrees(){[[15,270,0.65],[55,258,0.8],[850,262,0.75],[910,250,0.9],[940,272,0.6]].forEach(([tx,ty,s])=>{X.fillStyle='#4a2e14';X.fillRect(tx-4*s,ty,8*s,38*s);X.fillStyle='#1e4a14';X.beginPath();X.moveTo(tx,ty-38*s);X.lineTo(tx-22*s,ty+8);X.lineTo(tx+22*s,ty+8);X.fill();X.beginPath();X.moveTo(tx,ty-22*s);X.lineTo(tx-18*s,ty+18);X.lineTo(tx+18*s,ty+18);X.fill();});}

function drawBlock(x,y){X.fillStyle='#8B7355';X.fillRect(x-18,y-20,36,22);X.fillStyle='#a08060';X.beginPath();X.ellipse(x,y-20,18,7,0,0,Math.PI*2);X.fill();X.strokeStyle='#6b5535';X.lineWidth=1;X.beginPath();X.ellipse(x,y-20,12,4.5,0,0,Math.PI*2);X.stroke();}

function drawLog(log){
  if(log.done)return;
  const x=log.x,y=log.y,r=log.diam/2,sp=log.sp;
  // Barrel
  X.fillStyle=sp.logColor;X.fillRect(x-r,y-28-r*1.1,r*2,r*1.1);
  // Top face
  X.fillStyle=sp.ringColor;X.beginPath();X.ellipse(x,y-28-r*1.1,r,r*0.4,0,0,Math.PI*2);X.fill();
  X.strokeStyle=sp.logColor;X.lineWidth=1;
  for(let i=1;i<=3;i++){X.beginPath();X.ellipse(x,y-28-r*1.1,r*(i/4),r*0.4*(i/4),0,0,Math.PI*2);X.stroke();}
  X.strokeStyle='#3a2510';X.lineWidth=2;X.beginPath();X.ellipse(x,y-28-r*1.1,r,r*0.4,0,0,Math.PI*2);X.stroke();
  // Chop marks
  if(log.prog>0){X.strokeStyle='#ffe0a0';X.lineWidth=2;for(let i=0;i<log.prog;i++){const cx=x-(log.prog*2)+i*4;X.beginPath();X.moveTo(cx,y-28-r*1.6);X.lineTo(cx,y-28-r*0.5);X.stroke();}}
  // Progress bar
  const bW=r*2,bH=5,bX=x-r,bY=y-28-r*1.1-r*0.4-18;
  X.fillStyle='rgba(0,0,0,0.4)';X.fillRect(bX,bY,bW,bH);
  const pct=log.prog/log.max;
  X.fillStyle=pct>0.7?'#ff6644':pct>0.4?'#ffaa44':'#88cc44';
  X.fillRect(bX,bY,bW*pct,bH);
  X.strokeStyle='rgba(255,255,255,0.3)';X.lineWidth=1;X.strokeRect(bX,bY,bW,bH);
  // Hits left
  X.fillStyle='rgba(255,255,255,0.7)';X.font=gf(7);X.textAlign='center';
  X.fillText((log.max-log.prog)+'',x,bY-3);
  // Species label
  X.fillStyle=sp.color;X.font=gf(5);X.fillText(sp.abbr,x,bY-11);
}

// ─── FRESH WOOD PILES (below blocks) ───
function drawFreshPiles(){
  SPECIES.forEach((sp,si)=>{
    const count=freshWood[sp.id];if(!count)return;
    const bx=BLOCK_X[si],by=490;
    // Small pile
    for(let i=0;i<Math.min(count,30);i++){
      const r=Math.floor(i/6),c=i%6,px=bx-15+c*6,py=by-r*5;
      X.fillStyle=sp.color;X.fillRect(px-2,py-2,5,4);
    }
    X.fillStyle=sp.color;X.font=gf(6);X.textAlign='center';
    X.fillText(count+'',bx,by+12);
    X.fillStyle='#e8d5b0';X.font=gf(5);
    X.fillText(sp.abbr,bx,by+20);
    // Stack prompt
    if(count>=STACK_SIZE && !cutscene){
      const stacks=dryingStacks.filter(s=>s.speciesId===sp.id);
      if(stacks.length<MAX_STACKS_PER){
        const a=0.5+Math.sin(Date.now()*0.004)*0.4;X.globalAlpha=a;
        X.fillStyle='#90ff90';X.font=gf(7);
        X.fillText('PRESS S',bx,by+32);
        X.globalAlpha=1;
      }
    }
  });
}

// ─── DRYING STACKS ───
function drawDryingStacks(){
  dryingStacks.forEach(st=>{
    const x=st.x,y=st.y;
    const sp=SPECIES.find(s=>s.id===st.speciesId);
    // Stack of wood (neat rows)
    for(let r=0;r<5;r++){
      for(let c=0;c<4;c++){
        const px=x-8+c*5,py=y-r*4;
        X.fillStyle=st.done?sp.color:'#'+Math.floor(
          parseInt(sp.color.slice(1),16)*0.7+0x333333*0.3
        ).toString(16).padStart(6,'0');
        X.fillRect(px,py,4,3);
      }
    }
    // Border glow if done
    if(st.done){
      X.strokeStyle='#ffd700';X.lineWidth=1;
      X.strokeRect(x-10,y-20,24,24);
    }
    // Dry progress bar
    const bw=24,bh=3,bx=x-10,by=y-24;
    X.fillStyle='rgba(0,0,0,0.4)';X.fillRect(bx,by,bw,bh);
    if(st.done){X.fillStyle='#ffd700';}
    else{X.fillStyle='#66aaff';}
    X.fillRect(bx,by,bw*Math.min(1,st.dryProgress),bh);
    X.strokeStyle='rgba(255,255,255,0.2)';X.lineWidth=0.5;X.strokeRect(bx,by,bw,bh);
    // Label
    X.fillStyle=st.done?'#ffd700':'#aaa';X.font=gf(4);X.textAlign='center';
    X.fillText(sp.abbr,x+2,by-2);
    if(st.done){
      const a=0.4+Math.sin(Date.now()*0.005)*0.3;X.globalAlpha=a;
      X.fillStyle='#ffd700';X.font=gf(4);X.fillText('DRY!',x+2,by-8);X.globalAlpha=1;
    }
  });
}

// ─── MARKET (left) ───
const MX=40,MY=370;
function drawMarket(){
  X.fillStyle='#8B6914';X.fillRect(MX-25,MY-10,50,42);
  X.fillStyle='#cc3333';X.beginPath();X.moveTo(MX-32,MY-10);X.lineTo(MX+32,MY-10);X.lineTo(MX+28,MY-24);X.lineTo(MX-28,MY-24);X.closePath();X.fill();
  X.fillStyle='#fff';for(let s=-22;s<24;s+=11){X.beginPath();X.moveTo(MX+s,MY-10);X.lineTo(MX+s+5,MY-10);X.lineTo(MX+s+4,MY-24);X.lineTo(MX+s-1,MY-24);X.closePath();X.fill();}
  X.fillStyle='#a08060';X.fillRect(MX-27,MY+6,54,5);
  X.fillStyle='#fff';X.font=gf(6);X.textAlign='center';X.fillText('MARKET',MX,MY+2);
  X.fillStyle='#ffd700';X.beginPath();X.arc(MX,MY-32,7,0,Math.PI*2);X.fill();
  X.fillStyle='#b8960a';X.font=gf(8);X.fillText('$',MX,MY-29);
  const ready=getReadyStack();
  if(ready&&!cutscene){
    const a=0.5+Math.sin(Date.now()*0.004)*0.4;X.globalAlpha=a;
    X.fillStyle='#ffd700';X.font=gf(8);X.fillText('PRESS M',MX,MY-46);
    X.font=gf(6);X.fillText('SELL DRY!',MX,MY-56);X.globalAlpha=1;
  }
}

// ─── ANVIL ───
const AX_X=810,AX_Y=350;
function drawAnvil(){
  X.fillStyle='#555';X.fillRect(AX_X-12,AX_Y+5,24,12);X.fillStyle='#666';X.fillRect(AX_X-16,AX_Y-2,32,8);
  X.fillStyle='#777';X.beginPath();X.moveTo(AX_X-16,AX_Y-2);X.lineTo(AX_X-20,AX_Y-2);X.lineTo(AX_X-18,AX_Y+4);X.lineTo(AX_X-16,AX_Y+4);X.closePath();X.fill();
  if(cutscene&&cutscene.type==='axe'&&cutscene.phase>=2&&cutscene.phase<=3){X.globalAlpha=0.3+Math.sin(Date.now()*0.01)*0.15;X.fillStyle='#ff4400';X.beginPath();X.arc(AX_X,AX_Y-10,25,0,Math.PI*2);X.fill();X.globalAlpha=1;}
}
function drawAxeSign(){
  if(axeLv>=AXES.length-1)return;const n=AXES[axeLv+1],ux=AX_X,uy=AX_Y-48;
  X.fillStyle='#5c3a1e';X.fillRect(ux-3,uy+22,6,26);
  X.fillStyle='#c8a96e';X.fillRect(ux-38,uy-4,76,28);X.strokeStyle='#5c3a1e';X.lineWidth=2;X.strokeRect(ux-38,uy-4,76,28);
  X.fillStyle='#3a2510';X.font=gf(6);X.textAlign='center';X.fillText('AXE:'+n.name,ux,uy+8);
  X.fillStyle='#ffd700';X.fillText(n.cost+' coins',ux,uy+18);
  if(coins>=n.cost&&!cutscene){const a=0.5+Math.sin(Date.now()*0.005)*0.4;X.globalAlpha=a;X.fillStyle='#90ff90';X.font=gf(8);X.fillText('PRESS U',ux,uy-10);X.globalAlpha=1;}
}

// ─── COFFEE ───
const CX=900,CY=345;
function drawCoffeeShop(){
  if(coffeeLv>=COFFEES.length-1)return;const n=COFFEES[coffeeLv+1];
  X.fillStyle='#5c3a1e';X.fillRect(CX-2,CY+12,4,18);X.fillStyle='#a08060';X.fillRect(CX-18,CY+8,36,5);
  // Mug
  X.fillStyle='#d4d4d4';X.fillRect(CX-5,CY-8,10,13);X.fillStyle='#4a2810';X.fillRect(CX-4,CY-7,8,5);
  X.strokeStyle='#d4d4d4';X.lineWidth=2;X.beginPath();X.arc(CX+6,CY-1,3,-Math.PI/2,Math.PI/2);X.stroke();
  const t=Date.now()*0.003;X.strokeStyle='rgba(255,255,255,0.4)';X.lineWidth=1;
  for(let i=0;i<2;i++){X.beginPath();const sx=CX-2+i*4;X.moveTo(sx,CY-9);X.quadraticCurveTo(sx+Math.sin(t+i)*3,CY-14,sx+Math.sin(t+i+1)*2,CY-19);X.stroke();}
  X.fillStyle='#80e080';X.font=gf(6);X.textAlign='center';X.fillText(n.name,CX,CY+22);
  X.fillStyle='#ffd700';X.fillText(n.cost+'c',CX,CY+31);
  if(coins>=n.cost&&!cutscene){const a=0.5+Math.sin(Date.now()*0.005)*0.4;X.globalAlpha=a;X.fillStyle='#80e080';X.font=gf(7);X.fillText('C',CX,CY-16);X.globalAlpha=1;}
}

// ─── JERKY ───
const JX=900,JY=420;
function drawJerkyShop(){
  if(jerkyLv>=JERKYS.length-1)return;const n=JERKYS[jerkyLv+1];
  X.fillStyle='#5c3a1e';X.fillRect(JX-2,JY+12,4,18);X.fillStyle='#a08060';X.fillRect(JX-18,JY+8,36,5);
  X.fillStyle='#8B4513';X.fillRect(JX-6,JY-10,12,16);X.fillStyle='#a0522d';X.fillRect(JX-6,JY-10,12,3);
  X.fillStyle='#ffd700';X.font=gf(3);X.textAlign='center';X.fillText('JERKY',JX,JY);
  X.fillStyle='#ff9966';X.font=gf(6);X.fillText(n.name,JX,JY+22);
  X.fillStyle='#ffd700';X.fillText(n.cost+'c',JX,JY+31);
  if(coins>=n.cost&&!cutscene){const a=0.5+Math.sin(Date.now()*0.005)*0.4;X.globalAlpha=a;X.fillStyle='#ff9966';X.font=gf(7);X.fillText('J',JX,JY-16);X.globalAlpha=1;}
}

// ─── LUMBERJACK ───
function drawJack(){
  let x=J.x,y=J.y;const f=J.f;
  y+=J.walk?Math.sin(J.wt*0.3)*2:0;
  if(J.jitT>0){x+=(Math.random()-0.5)*J.jit;y+=(Math.random()-0.5)*J.jit*0.5;}
  X.save();X.translate(x,y);X.scale(f,1);
  let aa=0;
  if(J.chop){const p=J.cp;if(p<0.4)aa=-Math.PI*0.8*(p/0.4);else if(p<0.6)aa=-Math.PI*0.8+Math.PI*1.2*((p-0.4)/0.2);else aa=Math.PI*0.4*(1-(p-0.6)/0.4);}
  // Legs
  const ls=J.walk?Math.sin(J.wt*0.3)*8:0;
  X.fillStyle='#3a5fad';X.save();X.translate(-4,0);X.rotate(ls*Math.PI/180);X.fillRect(-4,0,8,18);X.fillStyle='#4a3020';X.fillRect(-4,16,10,5);X.restore();
  X.save();X.translate(4,0);X.rotate(-ls*Math.PI/180);X.fillStyle='#3a5fad';X.fillRect(-4,0,8,18);X.fillStyle='#4a3020';X.fillRect(-5,16,10,5);X.restore();
  // Body
  X.fillStyle='#c43030';X.fillRect(-10,-24,20,26);X.strokeStyle='#8a1a1a';X.lineWidth=2;for(let ly=-22;ly<2;ly+=6){X.beginPath();X.moveTo(-10,ly);X.lineTo(10,ly);X.stroke();}X.lineWidth=1;X.beginPath();X.moveTo(0,-24);X.lineTo(0,2);X.stroke();
  // Suspenders
  X.fillStyle='#5a3a1e';X.fillRect(-7,-22,3,44);X.fillRect(4,-22,3,44);
  X.fillStyle='#d4a030';X.beginPath();X.arc(-5.5,-4,1.5,0,Math.PI*2);X.fill();X.beginPath();X.arc(5.5,-4,1.5,0,Math.PI*2);X.fill();
  // Back arm
  X.fillStyle='#c43030';X.save();X.translate(-10,-20);
  const ba=J.chop?aa*0.3:(J.walk?Math.sin(J.wt*0.3+Math.PI)*15*Math.PI/180:0);
  X.rotate(ba);X.fillRect(-3,0,6,16);X.fillStyle='#e8b88a';X.fillRect(-2,14,5,5);X.restore();
  // Carrying
  if(J.carry){X.save();X.translate(0,-30);for(let i=0;i<Math.min(J.cc,5);i++){X.fillStyle=i%2===0?'#8B6914':'#a0522d';X.fillRect(-8+i*3,-6-i*4,10,7);X.fillStyle='#d4b86a';X.beginPath();X.ellipse(-3+i*3,-3-i*4,4,3,0,0,Math.PI*2);X.fill();}X.restore();}

  if(J.drink){
    X.save();X.translate(8,-18);X.rotate(-0.5);X.fillStyle='#c43030';X.fillRect(-3,-8,6,14);X.fillStyle='#e8b88a';X.fillRect(-2,4,5,5);X.fillStyle='#d4d4d4';X.fillRect(-1,-14,8,10);X.fillStyle='#4a2810';X.fillRect(0,-13,6,4);X.restore();
  } else if(J.eat){
    X.save();X.translate(8,-18);X.rotate(-0.3);X.fillStyle='#c43030';X.fillRect(-3,-6,6,14);X.fillStyle='#e8b88a';X.fillRect(-2,6,5,5);X.fillStyle='#6b3010';X.fillRect(0,-10,4,8);X.fillStyle='#8B4513';X.fillRect(1,-9,2,6);X.restore();
  } else if(J.flex){
    const bulge=Math.sin(J.flexT*0.15)*2;
    // Left arm flex
    X.save();X.translate(-10,-20);X.rotate(-1.2);X.fillStyle='#c43030';X.fillRect(-3,0,6,14);
    X.save();X.translate(0,14);X.rotate(-2.2);X.fillStyle='#c43030';X.fillRect(-3,0,6,12);X.fillStyle='#e8b88a';X.fillRect(-2,10,5,5);X.restore();
    X.fillStyle='#e8b88a';X.beginPath();X.ellipse(-1,7,5+bulge,4+bulge,0,0,Math.PI*2);X.fill();X.restore();
    // Right arm flex
    X.save();X.translate(10,-20);X.rotate(1.2);X.fillStyle='#c43030';X.fillRect(-3,0,6,14);
    X.save();X.translate(0,14);X.rotate(2.2);X.fillStyle='#c43030';X.fillRect(-3,0,6,12);X.fillStyle='#e8b88a';X.fillRect(-2,10,5,5);X.restore();
    X.fillStyle='#e8b88a';X.beginPath();X.ellipse(1,7,5+bulge,4+bulge,0,0,Math.PI*2);X.fill();X.restore();
  } else {
    // Normal front arm + axe
    X.save();X.translate(8,-22);
    const fa=J.chop?aa*0.8:(J.walk?Math.sin(J.wt*0.3)*15*Math.PI/180:0.1);
    X.rotate(fa);X.fillStyle='#c43030';X.fillRect(-3,0,6,16);X.fillStyle='#e8b88a';X.fillRect(-2,14,5,5);
    if(J.hasAxe){X.fillStyle='#8B7355';X.fillRect(1,14,3,28);const ax=AXES[axeLv];X.fillStyle=ax.color;X.beginPath();X.moveTo(0,38);X.lineTo(-8,44);X.lineTo(-6,48);X.lineTo(4,44);X.closePath();X.fill();X.fillStyle=ax.shine;X.beginPath();X.moveTo(-7,44);X.lineTo(-8,44);X.lineTo(-6,48);X.lineTo(-5,47);X.closePath();X.fill();if(axeLv>=3){X.globalAlpha=0.3+Math.sin(Date.now()*0.005)*0.15;X.shadowColor=ax.color;X.shadowBlur=8;X.fillStyle=ax.color;X.beginPath();X.moveTo(0,38);X.lineTo(-8,44);X.lineTo(-6,48);X.lineTo(4,44);X.closePath();X.fill();X.shadowBlur=0;X.globalAlpha=1;}}
    X.restore();
  }
  // Head
  X.fillStyle='#e8b88a';X.fillRect(-8,-38,16,14);X.fillStyle='#2a2a2a';X.fillRect(-5,-34,3,3);X.fillRect(3,-34,3,3);
  if(J.drink||J.eat||J.flex){X.fillStyle='#c07050';X.beginPath();X.arc(0,-26,3,0,Math.PI);X.fill();}
  else{X.fillStyle='#a06040';X.fillRect(-3,-27,6,2);}
  X.fillStyle='#5a3a1e';X.fillRect(-7,-26,14,4);X.fillRect(-5,-22,10,2);
  // Beanie
  X.fillStyle='#cc2222';X.beginPath();X.ellipse(0,-40,10,5,0,Math.PI,0);X.fill();X.fillRect(-10,-42,20,4);X.fillStyle='#991818';X.fillRect(-10,-40,20,3);X.fillStyle='#cc2222';X.beginPath();X.arc(0,-45,4,0,Math.PI*2);X.fill();
  X.restore();
  // Speed lines
  if(J.walk&&coffeeLv>=1){X.strokeStyle='rgba(255,200,100,0.25)';X.lineWidth=1;const d=-J.f;for(let i=0;i<coffeeLv+1;i++){const ly=J.y-20+i*12,lx=J.x+d*15;X.beginPath();X.moveTo(lx,ly);X.lineTo(lx+d*(10+coffeeLv*5),ly);X.stroke();}}
}

// ─── PARTICLES / ANIMS ───
function triggerSplit(log){
  const pc=3+Math.floor(Math.random()*3);
  for(let i=0;i<pc;i++){const a=(Math.PI*2*i/pc)+Math.random()*0.5;splitAnims.push({x:log.x,y:log.y-30,vx:Math.cos(a)*(2+Math.random()*3),vy:-3-Math.random()*4,r:log.diam/4,color:log.sp.logColor,fc:'#d4b86a',life:1,gnd:false,gy:log.y+5+Math.random()*15,rot:Math.random()*Math.PI,sp:log.sp});}
  freshWood[log.sp.id]+=pc;
}
function updateSplits(){splitAnims.forEach(s=>{if(!s.gnd){s.vy+=0.2;s.x+=s.vx;s.y+=s.vy;s.rot+=0.1;if(s.y>=s.gy){s.y=s.gy;s.gnd=true;s.vx=0;s.vy=0;}}if(s.gnd)s.life-=0.01;});splitAnims=splitAnims.filter(s=>s.life>0);}
function drawSplits(){splitAnims.forEach(s=>{X.save();X.globalAlpha=Math.max(0,s.life);X.translate(s.x,s.y);X.rotate(s.rot);const w=s.r,h=s.r*0.7;X.fillStyle=s.color;X.fillRect(-w/2,-h/2,w,h);X.fillStyle=s.fc;X.beginPath();X.ellipse(0,0,w/2-1,h/2-1,0,0,Math.PI*2);X.fill();X.restore();});}

function spawnChopP(x,y){for(let i=0;i<8;i++)particles.push({x,y:y-30,vx:(Math.random()-0.5)*4,vy:-Math.random()*3-1,life:1,c:Math.random()>0.5?'#d4b86a':'#8B7355',sz:2+Math.random()*3});}
function spawnCoinP(x,y,c){for(let i=0;i<c;i++)particles.push({x:x+(Math.random()-0.5)*30,y:y-20,vx:(Math.random()-0.5)*3,vy:-Math.random()*4-2,life:1,c:'#ffd700',sz:3+Math.random()*2});}
function spawnSparks(x,y){for(let i=0;i<12;i++)bsSparks.push({x,y,vx:(Math.random()-0.5)*6,vy:-Math.random()*5-2,life:1,c:Math.random()>0.5?'#ffa030':'#ff6600',sz:2+Math.random()*2});}
function updateP(){particles.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.vy+=0.15;p.life-=0.02;});particles=particles.filter(p=>p.life>0);bsSparks.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.vy+=0.12;p.life-=0.025;});bsSparks=bsSparks.filter(p=>p.life>0);}
function drawP(){[...particles,...bsSparks].forEach(p=>{X.globalAlpha=p.life;X.fillStyle=p.c;X.fillRect(p.x-p.sz/2,p.y-p.sz/2,p.sz,p.sz);});X.globalAlpha=1;}

function addMsg(x,y,t,c){floatMsgs.push({x,y,text:t,color:c,life:1});}
function updateMsgs(){floatMsgs.forEach(m=>{m.y-=0.7;m.life-=0.012;});floatMsgs=floatMsgs.filter(m=>m.life>0);}
function drawMsgs(){floatMsgs.forEach(m=>{X.globalAlpha=m.life;X.fillStyle=m.color;X.font=gf(11);X.textAlign='center';X.fillText(m.text,m.x,m.y);});X.globalAlpha=1;}

function nearest(){let n=null,d=Infinity;logs.forEach(l=>{if(l.done)return;const dd=Math.abs(J.x-l.x);if(dd<d){d=dd;n=l;}});return n;}
function nearestClose(){let n=null,d=55;logs.forEach(l=>{if(l.done)return;const dd=Math.abs(J.x-l.x);if(dd<d){d=dd;n=l;}});return n;}

function drawHint(){if(cutscene)return;const nl=nearestClose();if(nl&&!J.chop&&!J.walk){const a=0.5+Math.sin(Date.now()*0.005)*0.3;X.globalAlpha=a;X.fillStyle='#fff';X.font=gf(10);X.textAlign='center';X.fillText('CHOP',nl.x,nl.y-55-nl.diam);X.globalAlpha=1;}}

function drawMarketMsg(){if(!marketMsg)return;marketMsg.timer--;if(marketMsg.timer<=0){marketMsg=null;return;}X.globalAlpha=Math.min(1,marketMsg.timer/30);X.fillStyle=marketMsg.color;X.font=gf(14);X.textAlign='center';X.fillText(marketMsg.text,MX,MY-65-(90-marketMsg.timer)*0.4);X.globalAlpha=1;}

// ─── CUTSCENES ───
function updateCS(){
  if(!cutscene)return;cutscene.timer++;
  const cs=cutscene;
  if(cs.type==='sell'){
    // Walk to ready stack, pick up, walk to market, sell
    const st=cs.data.stack;
    if(cs.phase===0){J.tx=st.x;J.f=J.x>st.x?-1:1;if(Math.abs(J.x-st.x)<8){cs.phase=1;cs.timer=0;}}
    else if(cs.phase===1){J.walk=false;if(cs.timer>25){J.carry=true;J.cc=3;J.carrySpecies=st.speciesId;cs.phase=2;cs.timer=0;}}
    else if(cs.phase===2){J.tx=MX;J.f=-1;if(Math.abs(J.x-MX)<8){cs.phase=3;cs.timer=0;}}
    else if(cs.phase===3){J.walk=false;J.carry=false;
      if(cs.timer===1){
        const sp=SPECIES.find(s=>s.id===st.speciesId);
        const earned=Math.round(st.pieces*sp.coinsPer);
        coins+=earned;coinsEl.textContent=coins;
        dryingStacks=dryingStacks.filter(s=>s!==st);
        // Reindex remaining stacks of this species
        const remaining=dryingStacks.filter(s=>s.speciesId===st.speciesId);
        const si=SPECIES.findIndex(s=>s.id===st.speciesId);
        remaining.forEach((s,i)=>{const p=getStackPos(si,i);s.x=p.x;s.y=p.y;s.slot=i;});
        addMsg(MX,MY-80,'+'+earned+'!','#ffd700');
        spawnCoinP(MX,MY-20,15);
        marketMsg={text:'SOLD '+sp.abbr+'!',timer:90,color:'#ffd700'};
      }
      if(cs.timer>50)cutscene=null;
    }
  }
  else if(cs.type==='stack'){
    const si=cs.data.speciesIdx;const bx=BLOCK_X[si];
    if(cs.phase===0){J.tx=bx;J.f=J.x>bx?-1:1;if(Math.abs(J.x-bx)<8){cs.phase=1;cs.timer=0;}}
    else if(cs.phase===1){J.walk=false;if(cs.timer>20){J.carry=true;J.cc=4;cs.phase=2;cs.timer=0;}}
    else if(cs.phase===2){
      const sp=SPECIES[si];const existing=dryingStacks.filter(s=>s.speciesId===sp.id);
      const pos=getStackPos(si,existing.length);
      J.tx=pos.x;J.f=J.x>pos.x?-1:1;
      if(Math.abs(J.x-pos.x)<8){cs.phase=3;cs.timer=0;}
    }
    else if(cs.phase===3){J.walk=false;J.carry=false;
      if(cs.timer===1){addDryingStack(SPECIES[si].id);addMsg(J.x,J.y-80,'STACKED!','#90ff90');}
      if(cs.timer>30)cutscene=null;
    }
  }
  else if(cs.type==='axe'){
    if(cs.phase===0){J.tx=AX_X-25;J.f=1;if(Math.abs(J.x-(AX_X-25))<8){cs.phase=1;cs.timer=0;}}
    else if(cs.phase===1){J.walk=false;if(cs.timer===15)J.hasAxe=false;if(cs.timer>40){cs.phase=2;cs.timer=0;}}
    else if(cs.phase===2){J.walk=false;if(cs.timer%12===0)spawnSparks(AX_X,AX_Y);if(cs.timer>90){cs.phase=3;cs.timer=0;}}
    else if(cs.phase===3){if(cs.timer===1){coins-=cs.data.cost;coinsEl.textContent=coins;axeLv++;axeEl.textContent=AXES[axeLv].name;J.hasAxe=true;addMsg(AX_X,AX_Y-70,AXES[axeLv].name+' AXE!','#90e0ff');spawnCoinP(AX_X,AX_Y,10);}if(cs.timer>50)cutscene=null;}
  }
  else if(cs.type==='coffee'){
    if(cs.phase===0){J.tx=CX-20;J.f=1;if(Math.abs(J.x-(CX-20))<8){cs.phase=1;cs.timer=0;}}
    else if(cs.phase===1){J.walk=false;if(cs.timer===1){coins-=cs.data.cost;coinsEl.textContent=coins;coffeeLv++;coffeeEl.textContent=COFFEES[coffeeLv].name;J.drink=true;}if(cs.timer>50){cs.phase=2;cs.timer=0;}}
    else if(cs.phase===2){J.drink=false;J.jit=6;J.jitT=1;if(cs.timer===1){addMsg(J.x,J.y-80,COFFEES[coffeeLv].name+'!','#80e080');for(let i=0;i<20;i++)particles.push({x:J.x+(Math.random()-0.5)*20,y:J.y-20,vx:(Math.random()-0.5)*6,vy:-Math.random()*5-2,life:1,c:'#8B4513',sz:2+Math.random()*3});}J.jit=6*(1-cs.timer/80);if(cs.timer>80){J.jit=0;J.jitT=0;cutscene=null;}}
  }
  else if(cs.type==='jerky'){
    if(cs.phase===0){J.tx=JX-20;J.f=1;if(Math.abs(J.x-(JX-20))<8){cs.phase=1;cs.timer=0;}}
    else if(cs.phase===1){J.walk=false;if(cs.timer===1){coins-=cs.data.cost;coinsEl.textContent=coins;jerkyLv++;jerkyEl.textContent=JERKYS[jerkyLv].name;J.eat=true;}if(cs.timer>55){cs.phase=2;cs.timer=0;}}
    else if(cs.phase===2){J.eat=false;J.flex=true;J.flexT=0;if(cs.timer===1){addMsg(J.x,J.y-80,JERKYS[jerkyLv].name+'!','#ff9966');for(let i=0;i<15;i++)particles.push({x:J.x+(Math.random()-0.5)*20,y:J.y-20,vx:(Math.random()-0.5)*4,vy:-Math.random()*4-1,life:1,c:Math.random()>0.5?'#ff6633':'#ff9944',sz:2+Math.random()*3});}J.flexT=cs.timer;if(cs.timer>70){J.flex=false;J.flexT=0;cutscene=null;}}
  }
  else if(cs.type==='walkchop'){
    const lg=cs.data.log;
    if(lg.done){cutscene=null;return;}
    if(cs.phase===0){
      J.tx=lg.x;J.f=J.x>lg.x?-1:1;
      if(Math.abs(J.x-lg.x)<40){cs.phase=1;cs.timer=0;}
    }
    else if(cs.phase===1){
      J.walk=false;
      if(cs.timer===1){
        J.chop=true;J.cp=0;J.f=J.x<lg.x?1:J.x>lg.x?-1:J.f;
        setTimeout(()=>{
          if(lg.done)return;
          lg.prog++;spawnChopP(lg.x,lg.y);
          if(lg.prog>=lg.max){lg.done=true;logsChopped++;scoreEl.textContent=logsChopped;triggerSplit(lg);setTimeout(()=>spawnLog(),1200);}
        },350);
      }
      if(cs.timer>30){cutscene=null;}
    }
  }
}

// ─── ACTIONS ───
const coinsEl=document.getElementById('hCoins');
const axeEl=document.getElementById('hAxe');
const coffeeEl=document.getElementById('hCoffee');
const jerkyEl=document.getElementById('hJerky');
const scoreEl=document.getElementById('hScore');

function doChop(){
  if(isBusy())return;const nl=nearest();
  if(!nl)return;
  // If close enough, chop immediately
  if(Math.abs(J.x-nl.x)<55){
    J.chop=true;J.cp=0;J.f=J.x<nl.x?1:J.x>nl.x?-1:J.f;
    setTimeout(()=>{nl.prog++;spawnChopP(nl.x,nl.y);
      if(nl.prog>=nl.max){nl.done=true;logsChopped++;scoreEl.textContent=logsChopped;triggerSplit(nl);setTimeout(()=>spawnLog(),1200);}
    },350);
  } else {
    // Walk to it first, then chop
    startCS('walkchop',{log:nl});
  }
}

function doStack(){
  if(isBusy())return;
  // Find first species with 50+ fresh wood and room for stacks
  for(let si=0;si<SPECIES.length;si++){
    const sp=SPECIES[si];
    if(freshWood[sp.id]>=STACK_SIZE){
      const existing=dryingStacks.filter(s=>s.speciesId===sp.id);
      if(existing.length<MAX_STACKS_PER){startCS('stack',{speciesIdx:si});return;}
    }
  }
  addMsg(J.x,J.y-60,'Need 50+ wood!','#ff6666');
}

function doSell(){
  if(isBusy())return;
  const ready=getReadyStack();
  if(!ready){addMsg(MX,MY-50,'No dry wood!','#ff6666');return;}
  startCS('sell',{stack:ready});
}

function upgradeAxe(){
  if(isBusy())return;if(axeLv>=AXES.length-1){addMsg(AX_X,AX_Y-50,'MAX!','#ffd700');return;}
  const n=AXES[axeLv+1];if(coins<n.cost){addMsg(AX_X,AX_Y-50,'Need '+n.cost+'!','#ff6666');return;}
  startCS('axe',{cost:n.cost});
}
function buyCoffee(){
  if(isBusy())return;if(coffeeLv>=COFFEES.length-1){addMsg(CX,CY-30,'MAX!','#80e080');return;}
  const n=COFFEES[coffeeLv+1];if(coins<n.cost){addMsg(CX,CY-30,'Need '+n.cost+'!','#ff6666');return;}
  startCS('coffee',{cost:n.cost});
}
function buyJerky(){
  if(isBusy())return;if(jerkyLv>=JERKYS.length-1){addMsg(JX,JY-30,'MAX!','#ff9966');return;}
  const n=JERKYS[jerkyLv+1];if(coins<n.cost){addMsg(JX,JY-30,'Need '+n.cost+'!','#ff6666');return;}
  startCS('jerky',{cost:n.cost});
}

window.doChop=doChop;window.doStack=doStack;window.doSell=doSell;
window.upgradeAxe=upgradeAxe;window.buyCoffee=buyCoffee;window.buyJerky=buyJerky;

// ─── INPUT ───
C.addEventListener('click',e=>{if(isBusy())return;const g=s2g(e.clientX,e.clientY);J.tx=Math.max(30,Math.min(GW-30,g.x));});
C.addEventListener('touchstart',e=>{e.preventDefault();if(isBusy())return;const t=e.touches[0];const g=s2g(t.clientX,t.clientY);J.tx=Math.max(30,Math.min(GW-30,g.x));},{passive:false});
document.addEventListener('keydown',e=>{
  if(e.code==='Space'){e.preventDefault();doChop();}
  if(e.code==='KeyS')doStack();
  if(e.code==='KeyM')doSell();
  if(e.code==='KeyU')upgradeAxe();
  if(e.code==='KeyC')buyCoffee();
  if(e.code==='KeyJ')buyJerky();
});

// ─── UPDATE DRYING ───
let lastTime=0;
function updateDrying(dt){
  dryingStacks.forEach(st=>{
    if(st.done)return;
    st.dryProgress+=dt/st.dryTime;
    if(st.dryProgress>=1){st.dryProgress=1;st.done=true;}
  });
}

// ─── MAIN LOOP ───
function loop(ts){
  const dt=(ts-(lastTime||ts))/1000;lastTime=ts;gt=ts;

  const dx=J.tx-J.x;
  if(Math.abs(dx)>3&&!J.chop&&!J.drink&&!J.eat&&!J.flex){J.walk=true;J.x+=Math.sign(dx)*spd();J.f=dx>0?1:-1;J.wt++;}
  else if(!J.chop){J.walk=false;}
  if(J.chop){J.cp+=cspd();if(J.cp>=1){J.chop=false;J.cp=0;}}

  updateCS();updateP();updateSplits();updateMsgs();
  updateDrying(dt);

  X.clearRect(0,0,GW,GH);
  drawSky();drawClouds(ts);drawMountains();drawBgTrees();drawGround();
  drawDryingStacks();
  drawMarket();drawAnvil();drawAxeSign();drawCoffeeShop();drawJerkyShop();
  BLOCK_X.forEach(bx=>drawBlock(bx,420));
  logs.forEach(l=>drawLog(l));
  drawSplits();drawFreshPiles();
  drawJack();
  drawP();drawHint();drawMarketMsg();drawMsgs();

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>
</body>
</html>
